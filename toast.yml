image: python:3.9-slim
command_prefix: set -euo pipefail
tasks:
  install-packages:
    command:
    # gcc python3-dev needed to build psutil
      apt-get update && apt-get install -y curl git make gcc python3-dev
  install-node:
    dependencies:
      - install-packages
    command: |
      curl -sL https://deb.nodesource.com/setup_lts.x | bash -
      apt-get install -y nodejs
  install:
    dependencies:
      - install-node
    input_paths:
      - Makefile
      - Makefile-common.mk
      - .python-version
      - pyproject.toml
      - package.json
      - .pre-commit-config.yaml
    environment:
      # don't install hooks
      CI: true
    command: make install
  hooks:
    description: make hooks
    dependencies:
      - install
    input_paths:
    # needed to avoid running hooks on *.egg-info files generated by pip install -e .
      - .gitignore
      - fakesnow/
      - tests/
    command: |
      # needed for pre-commit to work and see files
      git init . --initial-branch=main
      git add fakesnow tests
      make hooks
